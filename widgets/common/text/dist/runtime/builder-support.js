define(["jimu-core","jimu-ui","jimu-ui/rich-text-editor"],(function(e,t,r){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=555)}({103:function(e,t,r){"use strict";var n=this;Object.defineProperty(t,"__esModule",{value:!0});var o=r(3),i=r(4);t.expreg=/\<exp((?!\<exp).)*((?!\<exp).)*\<\/exp\>/gim,t.areg=/\<a((?!\<a).)*((?!\<a).)*\<\/a\>/gm,t.expressionreg=/data-expression=\"(((?![\=|\>|\"]).)*)["\>|"\s)]/m,t.linkreg=/data-link=\"(((?![\=|\>|\"]).)*)["\>|"\s)]/m,t.uniqueidreg=/data-uniqueid=\"(((?![\=|\s|\>|\"]).)*)[\"\>|"\s)]/m,t.dsidreg=/data-dsid=\"(((?![\=|\>|\"]).)*)[\"\>|"\s)]/gm,t.hrefreg=/href="((?!").)*"/m,t.getDataSourceIds=function(e){return void 0===e&&(e=o.Immutable([])),e.map((function(e){return e.dataSourceId}))},t.getTextFormats=function(e){var t=e&&e.typography.fontFamilyBase||"Avenir Next",r=e&&e.typography.lineHeights.medium||"1.5",n=e&&e.body.color,o=e&&e.typography.fontSizeBase||"14px";return{font:t,linespace:r,color:n,size:o=i.styleUtils.remToPixel(o)}},t.replaceUseDataSourcesFields=function(e,r){if(e)return e.map((function(e){var n=e.dataSourceId,o=r?t.getUseDataSourceById(r,n):null;if(!o)return e.set("fields",[]);var i=o.fields;return e.set("fields",i)}))},t.getUseDataSourceById=function(e,t){return e.filter((function(e){return e.dataSourceId===t}))[0]},t.matchAll=function(e,t){for(var r,n=[];null!==(r=t.exec(e));)n.push(r[0]);return n},t.convertEncodeObject=function(e){try{return e=decodeURIComponent(e),JSON.parse(e)}catch(e){console.error(e)}},t.getUseDataSourceIds=function(e){for(var r,n=t.dsidreg,o=[];null!==(r=n.exec(e));){var i=r[1];i.indexOf(",")>0?(i=i.split(","),o=o.concat(i)):o.push(i)}return o},t.getInvalidDataSourceIds=function(e,r){var o=n.getUseDataSourceIds(e);if(o&&o.length){var i=t.getDataSourceIds(r),s=o.filter((function(e){return i.indexOf(e)<0}));return s.length?s:void 0}},t.getExpressions=function(e){var r=t.matchAll(e,t.expreg),n=o.Immutable({});return r.forEach((function(e){var r=e.match(t.expressionreg),o=e.match(t.uniqueidreg);if(r&&r[1]){var i=r[1],s=t.convertEncodeObject(i),a=o[1];n=n.set(a,s)}})),n},t.getLinks=function(e){var r=t.matchAll(e,t.areg),n=o.Immutable({});return r.forEach((function(e){var r=e.match(t.linkreg),o=e.match(t.uniqueidreg);if(r&&r[1]){var i=r[1],s=t.convertEncodeObject(i),a=o[1];if(!a||!s)return;n=n.set(a,s)}})),n},t.getAllExpressions=function(e){var r=t.getExpressions(e),n=t.getLinks(e);for(var o in n){var i=n[o];i.expression&&(r=r.set(o,i.expression))}return r},t.getExpressionParts=function(e){var t=[];for(var r in e){var n=e[r],o=n&&n.parts;o&&(t=t.concat(o))}return t},t.replaceHtmlExpression=function(e,r){return e.replace(t.expreg,(function(e){var n=e.match(t.uniqueidreg),o=n&&n[1];if(!o)return e;var i=r[o];return void 0!==i?i:e}))},t.replaceHtmlLinkHref=function(e,r,n){return e.replace(t.areg,(function(e){var i=e.match(t.uniqueidreg),s=i&&i[1];if(!s)return e;var a="",u=e.match(t.linkreg);if(u&&u[1]){var c=u[1],l=t.convertEncodeObject(c);return a=l&&l.expression?n[s]||"":o.urlUtils.getHrefFromLinkTo(l,r),e=e.replace(t.hrefreg,'href="'+a+'"')}}))}},175:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3),o=["title","height","width","class","style"],i=new(0,n.esri.Sanitizer)({whiteList:{h1:o,h2:o,h3:o,h4:o,h5:o,h6:o,span:o,p:o,s:o,strong:o,em:o,u:o,ol:o,ul:o,li:o,a:["href","target"].concat(o),exp:o},safeAttrValue:function(e,t,r,o){return"a"===e&&"href"===t?n.xss.escapeAttrValue(r):n.xss.safeAttrValue(e,t,r,o)},onIgnoreTagAttr:function(e,t,r,o){if("data-"===t.substr(0,5))return t+'="'+n.xss.escapeAttrValue(r)+'"'},css:{onIgnoreAttr:function(e,t){return"line-height"===e?"line-height: "+n.xss.escapeAttrValue(t):""}}},!0);t.sanitizer=i},177:function(e,t,r){"use strict";var n=this;Object.defineProperty(t,"__esModule",{value:!0});var o=r(3),i=r(4);t.getTextFormats=function(e){var t=e&&e.typography.fontFamilyBase||"Avenir Next",r=e&&e.typography.lineHeights.medium||"1.5",n=e&&e.body.color,o=e&&e.typography.fontSizeBase||"14px";return{font:t,linespace:r,color:n,size:o=i.styleUtils.remToPixel(o)}},t.mixinFormats=function(e,t){void 0===t&&(t={});var r=n.getTextFormats(e);return t=o.lodash.assign({},r,t)}},3:function(t,r){t.exports=e},4:function(e,r){e.exports=t},43:function(e,t){e.exports=r},555:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(556);t.default={Editor:n.RichEditor}},556:function(e,t,r){"use strict";var n,o=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};Object.defineProperty(t,"__esModule",{value:!0});var s=r(3),a=r(4),u=r(43),c=r(103),l=r(177),p=r(175),d={toolbar:!1,autoformat:{link:{trigger:/[\s]/,find:/https?:\/\/[\S]+|(www\.[\S]+)/gi,transform:function(e,t){return t?"http://"+e:e},format:"link"}},clipboard:{matchers:[["img",function(e,t){return{ops:[],length:0}}]]}},f=function(e){function t(t){var r=e.call(this,t)||this;return r.translate=function(e){var t=r.props.intl;return t?t.formatMessage({id:e,defaultMessage:a.defaultMessages[e]}):""},r.getStyle=function(){var e,t=r.props.useDataSources,n=c.getInvalidDataSourceIds(r.state.html,t);return n&&(e=n.map((function(e){return s.css(h||(h=i(['\n          exp[data-dsid*="','"] {\n            opacity: 0.5;\n            background: red;\n            outline: 1px solid white;\n          }\n        '],['\n          exp[data-dsid*="','"] {\n            opacity: 0.5;\n            background: red;\n            outline: 1px solid white;\n          }\n        '])),e)}))),s.css(g||(g=i(["",""],["",""])),e)},r.setEditorContents=function(e){var t=r.editor;t&&(e=p.sanitizer.sanitize(e),t.setContents(t.clipboard.convert(e),"silent"))},r.persistPartialConfig=function(){if(r.state.html!==r.props.text||r.state.placeholder!==r.props.placeholder){var e=s.Immutable({});return e=e.set("text",r.state.html).set("placeholder",r.state.placeholder),r.props.persistPartialConfig(e),r.state.html}return r.props.text},r.onExpressionStateChange=function(e){var t=r.props.widgetId;s.getAppStore().dispatch(s.appActions.widgetStatePropChange(t,"showExpression",e))},r.state={html:""},r.onEditorTextChange=r.onEditorTextChange.bind(r),r.handleQuillCreate=r.handleQuillCreate.bind(r),r.mixinFormats=r.mixinFormats.bind(r),r.isEditingPlaceholder=r.isEditingPlaceholder.bind(r),r.renderBubble=r.renderBubble.bind(r),r.renderExpression=r.renderExpression.bind(r),r.expressionHeaderPorps={show:!0,text:r.translate("dynamicContent"),onClose:function(){return r.onExpressionStateChange(!1)}},r.plugins=[r.renderBubble,r.renderExpression],r}return o(t,e),t.prototype.componentDidMount=function(){var e=this.props,t=e.text,r=e.placeholder;this.setState({html:t,placeholder:r})},t.prototype.mixinFormats=function(e){void 0===e&&(e={});var t=this.props.theme;return e=l.mixinFormats(t,e)},t.prototype.componentDidUpdate=function(e){var t=this.props.enabled;if(!t&&t!=e.enabled){var r=this.persistPartialConfig();this.isPlaceholderInEditor(r,this.state.placeholder)&&this.setEditorContents(this.state.placeholder)}if(t&&!e.enabled&&this.isPlaceholderInEditor(this.props.text,this.state.placeholder)){var n=this.editor,o=n.getText()||"";o=o.trim();var i=this.state.placeholder.replace(o,"\ufeff");this.setEditorContents(i),n.focus()}},t.prototype.componentWillUnmount=function(){this.props.onEditorDestory&&this.props.onEditorDestory(),this.persistPartialConfig(),this.editor=null},t.prototype.isEditingPlaceholder=function(){var e=this.props,t=e.enabled,r=e.text;return!t&&this.isBlank(r)},t.prototype.onEditorTextChange=function(e,t,r){"silent"!==r&&(this.isEditingPlaceholder()?this.setState({placeholder:e}):this.setState({html:e}))},t.prototype.isBlank=function(e){return!e||"<p></p>"===e||"<p>\ufeff</p>"===e||"<p><br></p>"===e},t.prototype.isPlaceholderInEditor=function(e,t){return this.isBlank(e)&&t},t.prototype.handleQuillCreate=function(e){this.editor=e;var t=this.props.text,r=this.state.placeholder||this.props.placeholder;this.isPlaceholderInEditor(t,r)&&this.setEditorContents(r),this.props.onEditorCreate(e)},t.prototype.renderBubble=function(e,t){return s.jsx(u.Bubble,{key:t,editor:e,mixFormats:this.mixinFormats,source:"user"})},t.prototype.renderExpression=function(e,t){var r=this.props,n=r.useDataSources,o=r.showExpression;return s.jsx(u.Expression,{key:t,source:"user",editor:e,open:o,dataSourceIds:c.getDataSourceIds(n),header:this.expressionHeaderPorps})},t.prototype.render=function(){var e=this.props,t=e.enabled,r=e.onEditorDestory,n=p.sanitizer.sanitize(this.props.text);return s.jsx(u.RichTextEditor,{css:this.getStyle(),modules:d,enabled:t,plugins:this.plugins,preserveWhitespace:!0,onEditorCreate:this.handleQuillCreate,onEditorDestory:r,onEditorTextChange:this.onEditorTextChange,defaultValue:n})},t}(s.React.PureComponent);t._Editor=f;var h,g;t.RichEditor=s.ReactRedux.connect((function(e,t){var r=!!(e.widgetsState[t.widgetId]||s.Immutable({})).showExpression;return{theme:e.theme,showExpression:r}}))(s.injectIntl(f))}})}));