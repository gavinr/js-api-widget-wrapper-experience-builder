define(["jimu-core"],(function(e){return function(e){var t={};function r(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(o,a,function(t){return e[t]}.bind(null,a));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(t,r){t.exports=e},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE",e.FeatureLayer="FEATURE_LAYER"}(t.DataSourceTypes||(t.DataSourceTypes={})),t.fixLayerId=function(e){return e.replace(/\s/g,"_")}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o,a,n,i,u=r(0);function s(e){var t=n.findOAuthInfo(e);if(!t){var r=u.getAppStore().getState().clientId,o=u.urlUtils.normalize(""+window.location.origin+u.urlUtils.getFolder(u.moduleLoader.resolveModuleFullPath("jimu-arcgis"))+"/oauth-callback.html");t=new a({appId:r,expiration:20159,portalUrl:e,authNamespace:"/",popup:!0,popupCallbackUrl:o}),n.registerOAuthInfos([t])}}function c(e){var t=u.SessionManager.getInstance();n.destroyCredentials(),e&&e.forEach((function(e){var r,o=e.toCredential(),a=t.getPortalInfo(e.portal);n.registerToken(o),!(o=n.findCredential(o.server))||n.findOAuthInfo(o.server)||(null===(r=a)||void 0===r?void 0:r.isMainPortal)||(o.scope="server"),a.isWebTier&&i.request.trustedServers.push(o.server)}))}function l(e,t){t!==u.SessionChangedReasonType.ArcGISJSSync&&c(e)}t.loadArcGISJSAPIModules=function(e){return u.loadDependency("jimu-arcgis").then((function(){return o||(o=u.moduleLoader.loadModules(["esri/identity/IdentityManager","esri/identity/OAuthInfo","esri/config"]).then((function(e){var t;n=e[0],a=e[1],i=e[2],n.useSignInPage=!1;var r=u.SessionManager.getInstance(),o=u.getAppStore().getState().portalUrl;(null===(t=r.getPortalInfo(o))||void 0===t?void 0:t.isWebTier)||s(o),s("https://devext.arcgis.com"),s("https://qaext.arcgis.com"),s("https://www.arcgis.com"),r.initFromCookie(),c(r.getSessions()),r.addSessionChangeListener(l),n.on("credential-create",(function(e){var t=e.credential;u.SessionManager.getInstance().addFromArcGisJSCredential(t)}))})).then((function(){return u.moduleLoader.loadModules(["dojo/promise/Promise","esri/config"])})).then((function(e){var t=e[0];e[1].request.proxyUrl=u.portalUrlUtils.getPortalProxyUrl(u.getAppStore().getState().portalUrl),t.prototype.toPromise=function(){var e=this;return new Promise((function(t,r){e.then((function(e){t(e)})).catch((function(e){r(e)}))}))}}))),o.then((function(){return u.moduleLoader.loadModules(e)}))}))}},function(e,t,r){"use strict";var o,a=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),i=r(2),u=r(1),s=function(e){function t(t){var r=e.call(this,t)||this;return r.type=u.DataSourceTypes.Map,r.isDataSourceSet=!0,r.map=t.map,r}return a(t,e),t.prototype.ready=function(){var e=this;return i.loadArcGISJSAPIModules(["esri/Map","esri/layers/FeatureLayer"]).then((function(t){return e.Map=t[0],e.FeatureLayer=t[1],e.map||e.createMap(),e.createChildDataSources(),e.whenChildDataSourcesCreated()}))},t.prototype.fetchSchema=function(){var e=this.getChildDataSources(),t=n.Immutable({childSchemas:{}});return e.map((function(r,o){var a=r.getFetchedSchema();t=t.setIn(["childSchemas",u.fixLayerId(e[o].layer.id)],a)})),Promise.resolve(t)},t.prototype.whenChildDataSourcesCreated=function(){return this.childDataSourcesPromise.then((function(e){return e}))},t.prototype.createMap=function(){var e=this;this.map=new this.Map,this.dataSourceJson.layers.forEach((function(t){e.map.layers.add(new e.FeatureLayer(t))}))},t.prototype.createChildDataSources=function(){var e=this,t=[];return this.map.layers.toArray().forEach((function(r){e.getJimuChildId(u.fixLayerId(r.id)).forEach((function(o){var a=e.dataSourceJson.schema?e.dataSourceJson.schema.childSchemas[o]:null,i=n.Immutable({id:e.getFullChildDataSourceId(o),type:u.DataSourceTypes.FeatureLayer,label:r.title});if(a&&(i=i.set("schema",a)),"feature"===r.type&&r.url){var s={dataSourceJson:i,layer:r,parentDataSource:e};t.push(e.dataSourceManager.createDataSource(s))}}))})),this.childDataSourcesPromise=Promise.all(t),this.childDataSourcesPromise},t.prototype.destroy=function(){var e=this;this.getChildDataSources().forEach((function(t){t&&e.dataSourceManager.destroyDataSource(t.id)}))},t}(n.AbstractDataSource);t.MapDataSource=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=r(1);t.ArcGISDataSourceTypes=o.DataSourceTypes,t.DataSourceTypes=o.DataSourceTypes;var a=r(3);t.MapDataSource=a.MapDataSource;var n=r(8);t.WebMapDataSource=n.WebMapDataSource;var i=r(9);t.WebSceneDataSource=i.WebSceneDataSource;var u=r(10);t.FeatureLayerDataSource=u.FeatureLayerDataSource;var s=r(5);t.FeatureDataRecord=s.FeatureDataRecord;var c=function(){function e(){}return e.prototype.createDataSource=function(e){var t=e.dataSourceJson;return t.type===o.DataSourceTypes.Map?new a.MapDataSource(e):t.type===o.DataSourceTypes.WebMap?new n.WebMapDataSource(e):t.type===o.DataSourceTypes.WebScene?new i.WebSceneDataSource(e):t.type===o.DataSourceTypes.FeatureLayer?new u.FeatureLayerDataSource(e):void console.error("Unimplemented data source type.",t.type)},e}();t.ArcGISDataSourceFactory=c},function(e,t,r){"use strict";var o,a=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),i=function(e){function t(t,r,o){void 0===o&&(o=!0);var a=e.call(this)||this;return a.dataSource=r,o?(t.attributes=a.convertBeforeMappingDataToData(t.attributes),a.feature=t):a.feature=t,a}return a(t,e),t.prototype.getData=function(){return this.feature.attributes},t.prototype.getFormattedFieldValue=function(t,r){var o=this.dataSource.getLayerDefinition(),a=n.dataSourceUtils.getDisplayValueForCodedValueOrSubtype(o,t,this.getData());return a.isCodedValueOrSubtype?a.displayValue:e.prototype.getFormattedFieldValue.call(this,t,r)},t.prototype.getDataBeforeMapping=function(){var e=this.feature.clone();return e.attributes=this.convertDataToDataBeforeMapping(this.getData()),e},t.prototype.toJson=function(){return this.feature.toJSON()},t.prototype.getId=function(){return this.feature.attributes[this.dataSource.getIdField()]+""},t.prototype.setId=function(e){},t.prototype.getGeometry=function(){return this.feature.geometry.toJSON()},t}(n.AbstractDataRecord);t.FeatureDataRecord=i},,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=r(4);t.default=o.ArcGISDataSourceFactory,function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(4))},function(e,t,r){"use strict";var o,a=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=r(1),i=r(3),u=r(2),s=r(0),c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=n.DataSourceTypes.WebMap,t}return a(t,e),t.prototype.ready=function(){var e=this;return u.loadArcGISJSAPIModules(["esri/WebMap","esri/portal/Portal","esri/portal/PortalItem"]).then((function(t){return e.WebMap=t[0],e.Portal=t[1],e.PortalItem=t[2],e.map||e.createMap(),e.createChildDataSources(),e.whenChildDataSourcesCreated()}))},t.prototype.createMap=function(){if(this.dataSourceJson.portalUrl){var e=new this.Portal({url:s.portalUrlUtils.getHostUrlByOrgUrl(this.dataSourceJson.portalUrl)});this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId,portal:e})})}else this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId})});this.map.isFulfilled()||this.map.load()},t.prototype.createChildDataSources=function(){var t=this;return this.childDataSourcesPromise=this.map.when((function(){return e.prototype.createChildDataSources.call(t)})).toPromise(),this.childDataSourcesPromise},t}(i.MapDataSource);t.WebMapDataSource=c},function(e,t,r){"use strict";var o,a=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=r(2),i=r(1),u=r(3),s=r(0),c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=i.DataSourceTypes.WebScene,t}return a(t,e),t.prototype.ready=function(){var e=this;return n.loadArcGISJSAPIModules(["esri/WebScene","esri/portal/Portal","esri/portal/PortalItem"]).then((function(t){return e.WebScene=t[0],e.Portal=t[1],e.PortalItem=t[2],e.map||e.createMap(),e.createChildDataSources(),e.whenChildDataSourcesCreated()}))},t.prototype.createMap=function(){if(this.dataSourceJson.portalUrl){var e=new this.Portal({url:s.portalUrlUtils.getHostUrlByOrgUrl(this.dataSourceJson.portalUrl)});this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId,portal:e})})}else this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId})});this.map.isFulfilled()||this.map.load()},t.prototype.createChildDataSources=function(){var t=this;return this.childDataSourcesPromise=this.map.when((function(){return e.prototype.createChildDataSources.call(t)})).toPromise()},t}(u.MapDataSource);t.WebSceneDataSource=c},function(e,t,r){"use strict";var o,a=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),u=r(2),s=r(1),c=r(11),l=r(5),p=function(e){function t(t){var r=e.call(this,t)||this;return r.jimuFeatureLayerViews={},r.layer=t.layer,r.url=t.layer.url,r}return a(t,e),t.prototype.ready=function(){var e=this;return u.loadArcGISJSAPIModules(["esri/layers/FeatureLayer"]).then((function(t){e.FeatureLayer=t[0]}))},t.prototype.doQuery=function(e){var t=this;if(e.outFields=e.outFields&&e.outFields.length>0?e.outFields:["*"],e.outFields&&"*"!==e.outFields[0]){var r=this.getLayerDefinition().typeIdField;r&&e.outFields.indexOf(r)<0&&e.outFields.push(r)}return this.layer.queryFeatures(e).then((function(r){var o=r.features.map((function(e){return new l.FeatureDataRecord(e,t)})),a=Object.keys(t.getSchema().fields).filter((function(e){return r.fields&&r.fields.find((function(r){return r.name===t.getSchema().fields[e].name}))}));return{queryParams:e,records:o,fields:a}})).toPromise()},t.prototype.doQueryCount=function(e){return this.layer.queryFeatureCount(e).toPromise().then((function(t){return{queryParams:e,count:t}}))},t.prototype.doQueryById=function(e){var t=this;return t.layer.queryFeatures({objectIds:[parseInt(e)],outFields:["*"],returnGeometry:!0}).then((function(e){return e.features.map((function(e){return new l.FeatureDataRecord(e,t)}))[0]})).toPromise()},t.prototype.mergeQueryParams=function(e,t){var r;return r=[e&&e.where,t&&t.where].filter((function(e){return e})).map((function(e){return""+e})).join(" and "),n(n(n({},e),t),{where:r})},t.prototype.getConfigQueryParams=function(){return this.dataSourceJson.query?{where:i.dataSourceUtils.getArcGISSQL(this.dataSourceJson.query.where,this).sql,orderByFields:this.getOrderBy(this.dataSourceJson.query.orderBy)}:null},t.prototype.getRealQueryParams=function(t,r,o){var a=e.prototype.getRealQueryParams.call(this,t,r,o);return this.getSchema().filter&&(a.where?a.where.indexOf(this.getSchema().filter)<0&&(a.where=a.where+" and "+this.getSchema().filter):a.where=this.getSchema().filter),a},t.prototype.getOrderBy=function(e){return e.map((function(e){return e.jimuFieldName+" "+e.order})).asMutable()},t.prototype.fetchSchema=function(){var e=this;return this.dataSourceJson.isStatistic?Promise.resolve(i.Immutable({})):this.layer.load().toPromise().then((function(){e._updateLayerDefinition();var t={fields:{},idField:e.layer.objectIdField,filter:e.layer.definitionExpression};return e.parentDataSource&&(t.childId=s.fixLayerId(e.layer.id),t.jimuChildId=s.fixLayerId(e.layer.id)),e.layer.fields.forEach((function(r){var o=e.layer.popupTemplate&&e.layer.popupTemplate.fieldInfos&&e.layer.popupTemplate.fieldInfos.find((function(e){return e.fieldName===r.name}));o&&(o=o.toJSON()),t.fields[r.name]=i.dataSourceUtils.convertFieldToJimuField(r.toJSON(),o)})),i.Immutable(t)}))},t.prototype._updateLayerDefinition=function(){var e=this.layer.sourceJSON,t=this.layer.renderer;if(t&&t.toJSON()){var r=t.toJSON();if("uniqueValue"===r.type){var o=this.layer.sourceJSON.types;r.field1!==this.layer.sourceJSON.typeIdField&&(o=[],r.uniqueValueInfos.map((function(e){o.push({id:e.value,name:e.label,domain:{}})}))),e=Object.assign({},e,{drawingInfo:{renderer:r},typeIdField:r.field1,types:o})}}this.layerDefinition=e},t.prototype.getLayerDefinition=function(){return this.layerDefinition},t.prototype.getFieldCodedValueList=function(e,t){var r="",o=this.getSchema().fields;return Object.keys(o).some((function(t){return t===e&&(r=o[t].name,!0)})),i.dataSourceUtils.getCodedValueListForCodedValueOrSubtypeField(this.getLayerDefinition(),r,t)},t.prototype.load=function(t){for(var r=this.jimuFeatureLayerViews,o=Object.keys(r),a=0;a<o.length;a++){r[o[a]].setDefinitionExpressionForLayer(this.getRealQueryParams(t,"load"))}return e.prototype.load.call(this,t)},t.prototype.selectRecordById=function(t){e.prototype.selectRecordById.call(this,t);for(var r=this.jimuFeatureLayerViews,o=Object.keys(r),a=0;a<o.length;a++){r[o[a]].highLightSelectedFeatures()}},t.prototype.selectRecordsByIds=function(t){e.prototype.selectRecordsByIds.call(this,t);for(var r=this.jimuFeatureLayerViews,o=Object.keys(r),a=0;a<o.length;a++){if(t)r[o[a]].highLightSelectedFeatures()}},t.prototype.addJimuFeatureLayerView=function(e){this.jimuFeatureLayerViews[e.id]=e},t.prototype.removeJimuFeatureLayerView=function(e){delete this.jimuFeatureLayerViews[e.id]},t}(i.AbstractQueriableDataSource);t.FeatureLayerDataSource=p,i.utils.applyMixins(p,[c.LayerDataSource])},function(e,t,r){"use strict";var o,a=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.prototype.getMapDataSource=function(){return this.getRootDataSource()},t}(r(0).AbstractDataSource);t.LayerDataSource=n}])}));